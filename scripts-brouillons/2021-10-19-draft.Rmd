---
title: "Comparaison de quelques sorties de modèles"
output: html_document
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

Dans ce Rmd on va comparer:

* *Modèle 1*:  Modèle avec K = exp(k) avec moment 1 en arcsinh.
    + $r=3%$, $\gamma = 2$
    + 1 paramètres estimé -> $\beta  = 0.9849$
*  *Modèle 2*: Modèle classique avec moment 1 en arcsinh.
    + $r=3%$
    + 2 paramètres estimés -> $\beta  = 0.9849 ; \gamma= 0.7129$;

Le 2e modèle correspond à celui de cet été dont on était assez content.

```{r, echo = FALSE}
library(data.table)
library(ggplot2)
path_data <- ".."
source("functions.R")


data <- construct_EP(path_data)


EP_2015 <- data[['EP_2015']]
EP_2018 <- data[['EP_2018']]
EP_lon <- data[['EP_lon']]

population <- readRDS("population.rds")
output <- readRDS("output_19102021.rds")
output_piste2 <- readRDS("./test_arctanh/output_piste2.rds")
output_new <- readRDS("output_20211020.rds")

beta_piste2  <- output_piste2$estimates$theta_hat['beta']
gamma_piste2 <- output_piste2$estimates$theta_hat['gamma']
r <- 0.03

clean_data <- function(data, sex_var = "SEXE",
                       diploma_var = "findet",
                       labor_income_var = "revenu",
                       total_income_var = "Y",
                       statut_var = NULL,
                       year = 2015){
  
  
  data[, c('SEXE') := data.table::fifelse(get(sex_var)==1,
                                          'Male',
                                          'Female')]
  data[, c('tr_diplome') := cut(get(diploma_var), breaks = c(min(get(diploma_var)), 16,18,21,25, max(get(diploma_var))), include.lowest = TRUE)]
  
  if (year != 2015) return(data)
  
  data[, c(labor_income_var) := get(labor_income_var) + exp(rnorm(nrow(data)))]
  data[, c(total_income_var) := get(total_income_var) + exp(rnorm(nrow(data)))]
  
  data[, c('decile_w') := cut(get(labor_income_var),
                              quantile(get(labor_income_var),
                                       probs= 0:10/10, na.rm = TRUE),
                              labels = 1:10, include.lowest = TRUE
  )]
  data[, c('decile_y') := cut(get(total_income_var),
                              quantile(get(total_income_var),
                                       probs= 0:10/10, na.rm = TRUE),
                              labels = 1:10, include.lowest = TRUE
  )]
  
  if (is.null(statut_var)) return(data)
  
  data[,'retired' := data.table::fifelse(get(statut_var) == "5",
                                         "retired","active")]
  
  return(data)  
}


EP_2015[,'y' := get('labor_income') + r*get('PATFISOM')]
EP_2015[, 'annee' := 2015]
clean_data(EP_2015, sex_var = "SEXE", labor_income_var = "labor_income", diploma_var = "AGFINETU",
           total_income_var = "y")

plot_K_age2 <- function(simulations, observed_data, has_ricardian = FALSE,
                        weight_observed_data = "POND",
                        wealth_var = "wealth",
                        trans = NULL,
                        trans_survey = NULL,
                        wealth_var_survey = 'PATRI_NET',
                        year_var = "annee",
                        age_var = "age",
                        age_var_survey = "AGE",
                        graduation_var = "findet",
                        observation_year = 2015,
                        start_year = 2009,
                        final_year = 2040,
                        method = "smooth"){
  
  
  simulations2 <- simulations[get(year_var) %between% c(start_year,final_year)]
  simulations2 <- simulations2[get(age_var)>get(graduation_var)]
  observed_data2 <- data.table::copy(observed_data)
  
  if (has_ricardian) simulations2 <- simulations2[!(non_ricardian)]
  
  if (!is.null(trans)){
    
    if (trans == "log"){
      simulations2[,'wealth' := log(wealth)]
    }
    if (trans == "exp"){
      simulations2[,'wealth' := exp(wealth)]
    }
  }  
  
  if (!is.null(trans_survey)){
    
    observed_data2 <- observed_data2[get(wealth_var_survey)>0]
    
    if (trans_survey == "log"){
      observed_data2[,c(wealth_var_survey) := log(get(wealth_var_survey))]
    }
    if (trans_survey == "exp"){
      observed_data2[,c(wealth_var_survey) := exp(get(wealth_var_survey))]
    }
  }  
  
  if (method != "smooth"){
  simulations2 <- simulations2[, .("wealth" = median(get(wealth_var), na.rm = TRUE)),
                               by = c(year_var, age_var)]
  simulations2[,'source' := "simulation"]
  }
  
  if (is.null(weight_observed_data)){
    observed_data2 <- observed_data2[,.("wealth" =  median(get(wealth_var_survey), na.rm = TRUE)),
                                    by = age_var_survey]
  } else{
    observed_data2 <- observed_data2[,.("wealth" =  Hmisc::wtd.quantile(get(wealth_var_survey), weights = get(weight_observed_data),
                                                                       na.rm = TRUE, probs = .5)),
                                    by = age_var_survey]
  }
  observed_data2[, c(year_var) := observation_year]
  observed_data2[,'source' := "survey"]
  data.table::setnames(observed_data2, old = age_var_survey, new = age_var)
  
  
  dataframes <- data.table::rbindlist(list(simulations2, observed_data2),
                                      use.names = TRUE, fill = TRUE)
  dataframes[,'size' := .5 + 0.5*as.numeric(get("source") == "survey")]
  
  
  ggplot(dataframes[age %between% c(30,75)]) + geom_line(aes(x = age, y = wealth/1000, color = factor(annee), size = size))

  ggplot(dataframes[age %between% c(30,75)]) + geom_smooth(aes(x = age, y = wealth/1000, color = factor(annee), linetype = factor(source == "survey")), se = FALSE)
  
  
}
```

On va tester, à chaque fois, ce que produit une paramétrisation de $\theta$
selon qu'on utilise le modèle classique ou le modèle $K = exp(k)$
Cela permet d'évaluer, à paramètres donnés, la stabilité de chaque modèle

# Modèle 1, modèle classique

Pour rappel, $\beta  = 1.158024$

```{r}
simulations3 <- capitulation::life_cycle_model(
  population,
  wealthvar_survey = "K_observed",
  r = r,
  beta = 1.158024,
  gamma = 2,
  observation_year = 2009,
  income_var = "revenu",
  Hgiven_var = "H_given",
  Hreceived_var = "H_received",
  scale_model = "level",
  return_last = FALSE,
  get_capital_income = TRUE,
  additional_vars = c("tr_age","SEXE","tr_agfinetu","findet"))
```

On peut commencer par comparer, année par année, $K(age)$. En gras, la
courbe pour 2009

```{r}
capitulation::plot_K_age(simulations3, xlims = c(30,75), method = "median")
```

Et ci-dessous la courbe de l'enquête patrimoine 2015 en pointillé

```{r}
plot_K_age2(simulations3[age>findet],EP_2015, method = "median")
```

Dans les deux cas, avec $\beta  = 1.158024$ on exagère énormément la courbe d'accumulation
au cours du cycle de vie.

# Modèle 1, K = exp(k)

```{r}
simulations2 <- capitulation::life_cycle_model(
  population,
  wealthvar_survey = "K_observed",
  r = r,
  beta = 1.158024,
  gamma = 2,
  observation_year = 2009,
  income_var = "revenu",
  Hgiven_var = "H_given",
  Hreceived_var = "H_received",
  scale_model = "log",
  return_last = FALSE,
  get_capital_income = TRUE,
  additional_vars = c("tr_age","SEXE","tr_agfinetu","findet"))
```

La courbe de cycle de vie en log donne

```{r}
capitulation::plot_K_age(simulations2, xlims = c(30,75), method = "median")
```

La courbe en gras ne correspond plus nécessairement à la distribution
observée dans patrimoine 2009 quand on utilise $K = exp(k)$.

Il vaut donc mieux regarder en niveau par rapport à 2015:

```{r}
simulations2[,'wealth' := exp(wealth)]
capitulation::plot_K_age(simulations2, xlims = c(30,75), method = "median")
plot_K_age2(simulations2[age>findet],EP_2015, method = "median")
```

La petite erreur de log devient, quand on regarde en niveau, 
une exagération énorme. 


# Modèle 2, version classique

Retour sur le modèle de cet été avec $\beta  = 0.9849 ; \gamma= 0.7129$


```{r}
simulations <- capitulation::life_cycle_model(
population,
wealthvar_survey = "K_observed",
r = r,
beta = beta_piste2,
gamma = gamma_piste2,
observation_year = 2009,
income_var = "revenu",
Hgiven_var = "hg",
Hreceived_var = "hr",
# return_last = TRUE,
get_capital_income = TRUE,
scale_model = "level",
additional_vars = c("tr_age_2015","sexe","findet"))
```

Le premier graph compare la trajectoire au niveau de l'enquête patrimoine 2009.
Le second graph compare la trajectoire au niveau de l'enquête patrimoine 2015.

On est à un niveau beaucoup plus satisfaisant.

```{r}
capitulation::plot_K_age(simulations, xlims = c(30,75), method = "median")
plot_K_age2(simulations[age>findet],EP_2015, method = "median")
```


# Modèle 2, modèle K = exp(k)

Même exercice avec un modèle $K = exp(k)$

```{r}
simulations4 <- capitulation::life_cycle_model(
  population,
  wealthvar_survey = "K_observed",
  r = r,
  beta = beta_piste2,
  gamma = gamma_piste2,
  observation_year = 2009,
  income_var = "revenu",
  Hgiven_var = "hg",
  Hreceived_var = "hr",
  # return_last = TRUE,
  get_capital_income = TRUE,
  scale_model = "log",
  additional_vars = c("tr_age_2015","sexe","findet"))
```

A nouveau, a priori satisfaisant en log-niveau mais exagère les variations

```{r}
capitulation::plot_K_age(simulations4, xlims = c(30,75), method = "median")

simulations4[,'wealth' := exp(wealth)]

capitulation::plot_K_age(simulations2, xlims = c(30,75), method = "median")
plot_K_age2(simulations2[age>findet],EP_2015, method = "median")
```


# Modèle 3

```{r}
simulations5 <- capitulation::life_cycle_model(
population,
wealthvar_survey = "K_observed",
r = r,
beta = as.numeric(output_new$estimates$theta_hat),
gamma = 0.71,
observation_year = 2009,
income_var = "revenu",
Hgiven_var = "hg",
Hreceived_var = "hr",
# return_last = TRUE,
get_capital_income = TRUE,
scale_model = "level",
additional_vars = c("tr_age_2015","sexe","findet"))
```

```{r}
capitulation::plot_K_age(simulations5, xlims = c(30,75), method = "median")
plot_K_age2(simulations5[age>findet],EP_2015, method = "median")
```

